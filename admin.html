<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="admin.css" />
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="app-container">
    <h1 class="app-title">Painel Administrativo</h1>
    <div id="diasLegenda" class="dias-legenda"></div>
    <div id="carousel" class="carousel-container"></div>

    <h2>Resumo de Pagamentos</h2>
    <div class="tabela-container">
      <table id="tabelaResumo">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Valor Total</th>
            <th>Data de Registro</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th colspan="2">Total Geral</th>
            <th id="totalGeral">R$ 0,00</th>
          </tr>
        </tfoot>
      </table>
    </div>

    <h2>Resumo Mensal</h2>
    <div class="tabela-container">
      <table id="tabelaMensal">
        <thead>
          <tr>
            <th>Mês</th>
            <th>Total Recebido</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modais -->
  <div id="modalPagamento" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Valor Recebido</h3>
      <input type="number" id="valorPago" placeholder="Digite o valor em R$" />
      <button id="confirmarPagamento">Confirmar</button>
      <button onclick="fecharModal()">Cancelar</button>
    </div>
  </div>

  <div id="modalNovoAgendamento" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Novo Agendamento</h3>
      <input type="text" id="novoNome" placeholder="Nome do cliente" />
      <input type="number" id="novaQuantidade" placeholder="Quantidade de alicates" style="width: 100px;" />
      <button id="confirmarNovoAgendamento">Salvar</button>
      <button onclick="fecharModalNovoAgendamento()">Cancelar</button>
    </div>
  </div>

  <script>
    // Formatadores
    function formatarDataBrasileira(dataStr) {
      const partes = dataStr.split("-");
      if (partes.length === 3) {
        return `${partes[2]}/${partes[1]}/${partes[0]}`;
      }
      return dataStr;
    }

    function formatarHorarioBrasileiro(horarioStr) {
      const timestamp = parseInt(horarioStr);
      if (!isNaN(timestamp)) {
        const data = new Date(timestamp);
        return data.toLocaleTimeString("pt-BR", { hour: '2-digit', minute: '2-digit' });
      }
      return horarioStr;
    }

    function formatarValor(valor) {
      return valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    const firebaseConfig = {
      apiKey: "AIzaSyCqImvbXx1nt0kpO9qP1OlvzYrOi02oh6U",
      authDomain: "dewta-df829.firebaseapp.com",
      projectId: "dewta-df829",
      storageBucket: "dewta-df829.appspot.com",
      messagingSenderId: "482045122323",
      appId: "1:482045122323:web:6e30a2f421a902d33b6ce6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let agendamentoAtual = null;
    let diaResumoAtual = null;

    async function carregarAgendamentos() {
      const carousel = document.getElementById("carousel");
      const legenda = document.getElementById("diasLegenda");
      carousel.innerHTML = "";
      legenda.innerHTML = "";

      const diasSnapshot = await db.collection("agendamentos").get();
      const agendamentos = [];

      diasSnapshot.forEach(diaDoc => {
        agendamentos.push({ dataStr: diaDoc.id, diaDoc });
      });

      agendamentos.sort((a, b) => new Date(a.dataStr) - new Date(b.dataStr));
      const hojeStr = new Date().toISOString().split("T")[0];
      let primeiroDiaVisivel = null;

      for (const { dataStr, diaDoc } of agendamentos) {
        const horariosSnapshot = await db.collection("agendamentos").doc(dataStr).collection("horarios").get();
        const coluna = document.createElement("div");
        coluna.className = "dia-coluna";
        coluna.setAttribute("data-dia", dataStr);

        const cards = [];

        horariosSnapshot.forEach(doc => {
          const dados = doc.data();
          const horarioStr = doc.id;
          const card = document.createElement("div");
          card.className = "agenda-card" + (dataStr === hojeStr ? " today" : "");
          card.innerHTML = `
            <div class="card-header">
              <span class="card-date">${formatarDataBrasileira(dataStr)}</span> - 
              <span class="card-time">${formatarHorarioBrasileiro(horarioStr)}</span>
            </div>
            <div class="card-body">
              <p><strong>Nome:</strong> ${dados.nome}</p>
              <p><strong>Qtd:</strong> ${dados.quantidade}</p>
            </div>
            <div class="card-actions">
              <button title="Concluir" onclick="abrirModal('${dataStr}', '${doc.id}', '${dados.nome}')">✔️</button>
            </div>
          `;
          cards.push(card);
        });

        cards.forEach(c => coluna.appendChild(c));

        const cardAdd = document.createElement("div");
        cardAdd.className = "agenda-card adicionar";
        cardAdd.innerHTML = `
          <div class="add-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
          </div>
          <p>Adicionar Agendamento</p>
        `;
        cardAdd.onclick = () => adicionarAgendamentoExtra(dataStr);
        coluna.appendChild(cardAdd);

        carousel.appendChild(coluna);

        const span = document.createElement("span");
        span.textContent = dataStr === hojeStr ? "Hoje" : formatarDataBrasileira(dataStr);
        span.setAttribute("data-dia", dataStr);
        legenda.appendChild(span);

        if (!primeiroDiaVisivel) primeiroDiaVisivel = dataStr;
      }

      marcarDiaAtivo();
      carregarResumoMensal();
      if (primeiroDiaVisivel) carregarResumoPagamentos(primeiroDiaVisivel);
    }

    function abrirModal(data, horario, nome) {
      agendamentoAtual = { data, horario, nome };
      document.getElementById("valorPago").value = "";
      document.getElementById("modalPagamento").style.display = "flex";
    }

    function fecharModal() {
      document.getElementById("modalPagamento").style.display = "none";
    }

    document.getElementById("confirmarPagamento").addEventListener("click", async () => {
      const valor = parseFloat(document.getElementById("valorPago").value);
      if (isNaN(valor) || valor <= 0) {
        alert("Digite um valor válido.");
        return;
      }

      const { data, horario, nome } = agendamentoAtual;
      const dataRegistro = new Date();

      try {
        await db.collection("agendamentos").doc(data)
          .collection("pagamentos").add({ nome, valor, dataRegistro });

        await db.collection("agendamentos").doc(data)
          .collection("horarios").doc(horario).delete();

        fecharModal();
        carregarAgendamentos();
      } catch (e) {
        console.error("Erro ao registrar pagamento:", e);
        alert("Erro ao concluir agendamento.");
      }
    });

    async function carregarResumoPagamentos(dataStr) {
      if (diaResumoAtual === dataStr) return;
      diaResumoAtual = dataStr;

      const tabela = document.getElementById("tabelaResumo").querySelector("tbody");
      const totalGeralEl = document.getElementById("totalGeral");
      tabela.innerHTML = "";
      let totalGeral = 0;
      const resumo = [];

      const pagamentos = await db.collection("agendamentos").doc(dataStr).collection("pagamentos").get();
      pagamentos.forEach(doc => {
        const { nome, valor, dataRegistro } = doc.data();
        const dataFormatada = dataRegistro
          ? new Date(dataRegistro.seconds * 1000).toLocaleDateString("pt-BR")
          : "—";
        resumo.push({ nome, valor, dataFormatada });
        totalGeral += valor;
      });

      if (resumo.length === 0) {
        tabela.innerHTML = `<tr><td colspan="3" style="text-align: center;">Nenhum pagamento registrado neste dia</td></tr>`;
      } else {
        resumo.forEach(item => {
          const linha = document.createElement("tr");
          linha.innerHTML = `<td>${item.nome}</td><td>${formatarValor(item.valor)}</td><td>${item.dataFormatada}</td>`;
          tabela.appendChild(linha);
        });
      }

      totalGeralEl.textContent = formatarValor(totalGeral);
    }

    async function carregarResumoMensal() {
      const tabela = document.getElementById("tabelaMensal").querySelector("tbody");
      tabela.innerHTML = "";

      const meses = {};
      const nomesMeses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

      const diasSnapshot = await db.collection("agendamentos").get();
      for (const diaDoc of diasSnapshot.docs) {
        const dataStr = diaDoc.id;
        const pagamentosSnapshot = await db.collection("agendamentos").doc(dataStr).collection("pagamentos").get();

        pagamentosSnapshot.forEach(doc => {
          const { valor, dataRegistro } = doc.data();
          const data = dataRegistro ? new Date(dataRegistro.seconds * 1000) : new Date(dataStr);
          const chave = `${data.getFullYear()}-${data.getMonth()}`;
          if (!meses[chave]) meses[chave] = 0;
          meses[chave] += valor;
        });
      }

      Object.entries(meses).sort().forEach(([chave, total]) => {
        const [ano, mes] = chave.split("-");
        const mesNome = `${nomesMeses[parseInt(mes)]} ${ano}`;
        const linha = document.createElement("tr");
        linha.innerHTML = `<td>${mesNome}</td><td>${formatarValor(total)}</td>`;
        tabela.appendChild(linha);
      });
    }

    function marcarDiaAtivo() {
      const carousel = document.getElementById("carousel");
      const legenda = document.getElementById("diasLegenda");
      const spans = legenda.querySelectorAll("span");
      const colunas = carousel.querySelectorAll(".dia-coluna");

      function atualizarLegendaVisivel() {
        let minDist = Infinity;
        let diaVisivel = null;

        colunas.forEach(col => {
          const rect = col.getBoundingClientRect();
          const dist = Math.abs(rect.left);
          if (dist < minDist) {
            minDist = dist;
            diaVisivel = col.getAttribute("data-dia");
          }
        });

        spans.forEach(span => {
          const ativo = span.getAttribute("data-dia") === diaVisivel;
          span.classList.toggle("active", ativo);

          if (ativo) {
            const containerRect = legenda.getBoundingClientRect();
            const spanRect = span.getBoundingClientRect();
            const offset = spanRect.left - containerRect.left - (containerRect.width / 2) + (spanRect.width / 2);
            legenda.scrollBy({ left: offset, behavior: "smooth" });
          }
        });

        if (diaVisivel) carregarResumoPagamentos(diaVisivel);
      }

      carousel.addEventListener("scroll", () => {
        clearTimeout(carousel._scrollTimer);
        carousel._scrollTimer = setTimeout(atualizarLegendaVisivel, 100);
      });

      spans.forEach(span => {
        span.addEventListener("click", () => {
          const dia = span.getAttribute("data-dia");
          const destino = carousel.querySelector(`[data-dia="${dia}"]`);
          if (destino) destino.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
        });
      });

      atualizarLegendaVisivel();
    }

    let dataParaNovoAgendamento = null;

    function adicionarAgendamentoExtra(dataStr) {
      dataParaNovoAgendamento = dataStr;
      document.getElementById("novoNome").value = "";
      document.getElementById("novaQuantidade").value = "";
      document.getElementById("modalNovoAgendamento").style.display = "flex";
    }

    function fecharModalNovoAgendamento() {
      document.getElementById("modalNovoAgendamento").style.display = "none";
    }

    document.getElementById("confirmarNovoAgendamento").addEventListener("click", async () => {
      const nome = document.getElementById("novoNome").value.trim();
      const quantidade = parseInt(document.getElementById("novaQuantidade").value);

      if (!nome || isNaN(quantidade) || quantidade <= 0) {
        alert("Preencha corretamente os campos.");
        return;
      }

      const horarioId = `${Date.now()}`;
      const novoAgendamento = {
        nome,
        quantidade,
        contato: "—",
        local: "—"
      };

      try {
        await db.collection("agendamentos").doc(dataParaNovoAgendamento)
          .collection("horarios").doc(horarioId).set(novoAgendamento);

        fecharModalNovoAgendamento();
        carregarAgendamentos();
      } catch (e) {
        console.error("Erro ao adicionar agendamento extra:", e);
        alert("Erro ao salvar agendamento.");
      }
    });

    carregarAgendamentos();
  </script>

  <div style="display: flex; justify-content: center; gap: 20px; margin: 30px 0;">
    <button onclick="window.open('btadc.html', '_blank')" style="padding: 10px 20px; font-size: 16px;">
      Ajustes
    </button>
    <button onclick="window.open('index.html', '_blank')" style="padding: 10px 20px; font-size: 16px;">
      Agendamento
    </button>
  </div>
</body>
</html>